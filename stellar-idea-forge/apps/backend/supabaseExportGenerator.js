/**
 * Supabase Export Generator
 * Generates one-click deployment links and commands for Supabase schemas
 * Enables users to easily import schemas into their Supabase dashboard with simple copy-paste instructions
 */

require('dotenv').config();

/**
 * Encodes SQL for safe URL transmission
 * @param {string} sql - The SQL string to encode
 * @returns {string} URL-encoded SQL string
 */
function encodeSQLForURL(sql) {
    return encodeURIComponent(sql);
}

/**
 * Generates a shareable SQL snippet for Supabase dashboard
 * @param {string} sql - The SQL to format
 * @returns {string} Formatted SQL with comments and instructions
 */
function formatSQLForDashboard(sql) {
    const timestamp = new Date().toISOString().split('T')[0];
    const formattedSQL = `-- Generated by Stellar Idea Forge - ${timestamp}
-- Copy and paste this SQL into your Supabase SQL Editor
-- Navigate to: Project Dashboard > SQL Editor > New Query

${sql}

-- After running the SQL, you can:
-- 1. View your new table in the Table Editor
-- 2. Set up Row Level Security (RLS) policies
-- 3. Create API endpoints automatically
-- 4. Add real-time subscriptions if needed

-- ğŸš€ Your table is ready for development!`;

    return formattedSQL;
}

/**
 * Generates Supabase dashboard URL for SQL execution
 * @param {string} projectId - Supabase project ID (can be mock for demo)
 * @param {string} sql - SQL to execute
 * @returns {string} Direct dashboard URL
 */
function generateDashboardURL(projectId, sql) {
    const encodedSQL = encodeSQLForURL(sql);
    return `https://supabase.com/dashboard/project/${projectId}/sql?sql=${encodedSQL}`;
}

/**
 * Generates CLI commands for schema deployment
 * @param {string} sql - SQL to deploy
 * @param {string} migrationName - Name for the migration
 * @returns {object} CLI commands and instructions
 */
function generateCLICommands(sql, migrationName = 'create_initial_schema') {
    const commands = {
        createMigration: `supabase migration new ${migrationName}`,
        deployLocal: `supabase db reset`,
        deployRemote: `supabase db push`,
        status: `supabase migration list`
    };

    const instructions = [
        "1. ğŸ—ï¸ Instala Supabase CLI: npm install -g supabase",
        "2. ğŸ”‘ Conecta tu proyecto: supabase login",
        "3. ğŸ“ Inicializa en tu directorio: supabase init",
        "4. âœ¨ Crea migraciÃ³n: " + commands.createMigration,
        "5. ğŸ“‹ Copia el SQL al archivo creado en supabase/migrations/",
        "6. ğŸš€ Aplica cambios: " + commands.deployRemote
    ];

    return {
        commands,
        instructions,
        sqlContent: sql,
        migrationFileName: `supabase/migrations/${Date.now()}_${migrationName}.sql`
    };
}

/**
 * Creates step-by-step visual instructions for non-technical users
 * @param {string} method - Deployment method ('dashboard' or 'cli')
 * @param {string} deployLink - The deployment link or primary command
 * @returns {array} Array of instruction steps with emojis
 */
function createUserInstructions(method, deployLink) {
    if (method === 'dashboard') {
        return [
            "ğŸ¯ **MÃ©todo Dashboard (MÃ¡s FÃ¡cil)**",
            "",
            "**Paso 1:** ğŸŒ Abre tu proyecto Supabase",
            "ğŸ‘‰ Ve a: https://supabase.com/dashboard",
            "",
            "**Paso 2:** âš¡ Accede al Editor SQL",
            "ğŸ‘‰ Click en 'SQL Editor' en el menÃº lateral",
            "ğŸ‘‰ Click en 'New Query'",
            "",
            "**Paso 3:** ğŸ“‹ Copia y pega el SQL",
            "ğŸ‘‰ Copia todo el cÃ³digo SQL de abajo",
            "ğŸ‘‰ PÃ©galo en el editor",
            "",
            "**Paso 4:** ğŸš€ Ejecuta el comando",
            "ğŸ‘‰ Click en 'Run' o presiona Ctrl+Enter",
            "ğŸ‘‰ Â¡Tu tabla estarÃ¡ lista en segundos!",
            "",
            "**Paso 5:** âœ… Verifica tu tabla",
            "ğŸ‘‰ Ve a 'Table Editor' para ver tu nueva tabla",
            "ğŸ‘‰ Ya puedes empezar a usar tu base de datos"
        ];
    } else {
        return [
            "ğŸ› ï¸ **MÃ©todo CLI (Para Desarrolladores)**",
            "",
            "**Paso 1:** âš™ï¸ Instala Supabase CLI",
            "ğŸ‘‰ Ejecuta: `npm install -g supabase`",
            "",
            "**Paso 2:** ğŸ” Conecta tu cuenta",
            "ğŸ‘‰ Ejecuta: `supabase login`",
            "ğŸ‘‰ Autoriza en el navegador",
            "",
            "**Paso 3:** ğŸ“ Inicializa proyecto",
            "ğŸ‘‰ En tu directorio: `supabase init`",
            "",
            "**Paso 4:** ğŸ“ Crea migraciÃ³n",
            "ğŸ‘‰ Ejecuta: `supabase migration new create_schema`",
            "",
            "**Paso 5:** ğŸ“‹ Agrega el SQL",
            "ğŸ‘‰ Copia el SQL al archivo creado en supabase/migrations/",
            "",
            "**Paso 6:** ğŸš€ Despliega",
            "ğŸ‘‰ Ejecuta: `supabase db push`"
        ];
    }
}

/**
 * Main function to generate deployment link and instructions
 * @param {object} schemaJson - Schema JSON from supabaseSchemaGenerator
 * @param {object} options - Configuration options
 * @returns {object} Deployment information with links, commands, and instructions
 */
function generateDeployLink(schemaJson, options = {}) {
    console.log('ğŸ”— Generating one-click deployment options...');
    
    try {
        // Validate input schema
        if (!schemaJson || !schemaJson.schema || !schemaJson.schema.sql) {
            throw new Error('Invalid schema JSON provided');
        }

        // Extract SQL and metadata
        const sql = schemaJson.schema.sql;
        const metadata = schemaJson.schema.metadata || {};
        const tables = schemaJson.schema.tables || [];
        
        // Configuration with defaults
        const config = {
            projectId: options.projectId || process.env.SUPABASE_PROJECT_ID || 'demo-project-123',
            method: options.method || 'both', // 'dashboard', 'cli', or 'both'
            includeRLS: options.includeRLS || false,
            includeSampleData: options.includeSampleData || false,
            ...options
        };

        // Generate formatted SQL for dashboard
        const formattedSQL = formatSQLForDashboard(sql);
        
        // Generate dashboard deployment URL
        const dashboardURL = generateDashboardURL(config.projectId, formattedSQL);
        
        // Generate CLI commands and instructions
        const cliInfo = generateCLICommands(sql, `create_${tables[0]?.name || 'schema'}`);
        
        // Create user-friendly instructions
        const dashboardInstructions = createUserInstructions('dashboard', dashboardURL);
        const cliInstructions = createUserInstructions('cli', cliInfo.commands.deployRemote);

        // Generate the complete export result
        const exportResult = {
            deployLink: dashboardURL,
            instructions: "ğŸš€ **Â¡Despliega tu esquema en 1 click!** Elige tu mÃ©todo favorito abajo ğŸ‘‡",
            
            // Dashboard method (recommended for non-technical users)
            dashboard: {
                url: dashboardURL,
                quickLink: `https://supabase.com/dashboard/project/${config.projectId}/sql`,
                sql: formattedSQL,
                instructions: dashboardInstructions,
                title: "ğŸ“Š MÃ©todo Dashboard (Recomendado)"
            },
            
            // CLI method (for developers)
            cli: {
                commands: cliInfo.commands,
                migrationFile: cliInfo.migrationFileName,
                sql: sql,
                instructions: cliInstructions,
                title: "ğŸ’» MÃ©todo CLI (Para Desarrolladores)"
            },
            
            // Quick copy-paste sections
            quickActions: {
                copySQL: {
                    title: "ğŸ“‹ SQL para copiar y pegar:",
                    content: formattedSQL,
                    instruction: "Copia este SQL y pÃ©galo en el SQL Editor de tu dashboard de Supabase"
                },
                copyCommands: {
                    title: "âš¡ Comandos CLI:",
                    content: Object.values(cliInfo.commands).join('\n'),
                    instruction: "Ejecuta estos comandos en tu terminal (requiere Supabase CLI instalado)"
                }
            },
            
            // Metadata and validation
            metadata: {
                generatedAt: new Date().toISOString(),
                schemaHash: Buffer.from(sql).toString('base64').substring(0, 8),
                tableCount: tables.length,
                tableName: tables[0]?.name || 'unknown',
                projectId: config.projectId,
                sqlLength: sql.length,
                deploymentMethods: ['dashboard', 'cli'],
                isTestMode: config.projectId.includes('demo') || config.projectId.includes('test')
            },
            
            // Validation and next steps
            nextSteps: [
                "âœ… Ejecuta el SQL en tu proyecto Supabase",
                "ğŸ”’ Configura Row Level Security (RLS) policies",
                "ğŸŒ Prueba los endpoints de API automÃ¡ticos",
                "ğŸ“± Conecta desde tu aplicaciÃ³n frontend",
                "ğŸ”„ Agrega suscripciones en tiempo real si necesitas"
            ],
            
            // Troubleshooting tips
            troubleshooting: {
                "Error de sintaxis SQL": "Verifica que copiaste todo el cÃ³digo SQL completo",
                "Proyecto no encontrado": "AsegÃºrate de estar en el proyecto correcto de Supabase",
                "Permisos insuficientes": "Verifica que tienes permisos de administrador en el proyecto",
                "CLI no reconocido": "Instala Supabase CLI con: npm install -g supabase"
            }
        };

        console.log('âœ… Export options generated successfully');
        console.log(`ğŸ“Š Dashboard URL: ${dashboardURL.substring(0, 60)}...`);
        console.log(`ğŸ’» CLI commands ready for table: ${tables[0]?.name || 'unknown'}`);
        
        return exportResult;

    } catch (error) {
        console.error('âŒ Error generating deployment link:', error);
        
        return {
            error: {
                message: error.message,
                type: 'export_generation_error'
            },
            deployLink: null,
            instructions: "âŒ Error generando opciones de despliegue. Verifica que el esquema JSON sea vÃ¡lido.",
            fallback: {
                manualInstructions: [
                    "1. ğŸŒ Ve a tu dashboard de Supabase",
                    "2. âš¡ Click en 'SQL Editor'",
                    "3. ğŸ“‹ Copia y pega tu SQL manualmente",
                    "4. ğŸš€ Ejecuta con 'Run'"
                ]
            }
        };
    }
}

/**
 * Helper function to validate export result
 * @param {object} exportResult - Generated export result
 * @returns {boolean} True if export result is valid
 */
function validateExportResult(exportResult) {
    if (!exportResult) return false;
    if (exportResult.error) return false;
    if (!exportResult.deployLink) return false;
    if (!exportResult.dashboard || !exportResult.cli) return false;
    if (!exportResult.dashboard.sql || !exportResult.cli.sql) return false;
    
    return true;
}

/**
 * Demo function to show export generation with sample schemas
 */
function demonstrateExportGeneration() {
    console.log('\nğŸ§ª Demonstrating Export Generation...\n');
    
    // Sample schema (mimicking output from supabaseSchemaGenerator)
    const sampleSchema = {
        schema: {
            tables: [{
                name: "users",
                displayName: "Users",
                fields: [
                    { name: "id", isPrimaryKey: true },
                    { name: "email", isRequired: true },
                    { name: "wallet_address" }
                ]
            }],
            sql: "CREATE TABLE users (\n    id SERIAL PRIMARY KEY,\n    email TEXT NOT NULL,\n    wallet_address TEXT\n);",
            metadata: {
                generatedAt: new Date().toISOString(),
                context: "hybrid_recommendation"
            }
        }
    };

    console.log('--- Sample Export Generation ---');
    const exportResult = generateDeployLink(sampleSchema);
    
    console.log('\nğŸ“Š Dashboard URL:', exportResult.deployLink);
    console.log('\nğŸ’» CLI Command:', exportResult.cli?.commands?.deployRemote);
    console.log('\nğŸ“‹ Instructions Preview:');
    console.log(exportResult.dashboard?.instructions?.slice(0, 3).join('\n'));
    console.log('\nâœ… Export generation completed!');
    
    return exportResult;
}

// Export the main functions and utilities
module.exports = {
    generateDeployLink,
    validateExportResult,
    demonstrateExportGeneration,
    encodeSQLForURL,
    formatSQLForDashboard,
    createUserInstructions
};

// If this file is run directly, demonstrate the functionality
if (require.main === module) {
    demonstrateExportGeneration();
}